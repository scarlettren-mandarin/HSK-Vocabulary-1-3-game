<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>YCT Vocabulary Mastery</title>
    <style>
        :root { --primary: #52c41a; --success: #1890ff; --error: #ff4d4f; --bg: #f0f2f5; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ç™»å½•é®ç½© */
        #loginView {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .main-title { text-align: center; font-size: 32px; color: #52c41a; margin-top: 20px; font-weight: 800; }
        #levelSelector { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 30px 0; }
        
        .lvl-btn { padding: 10px 20px; border-radius: 20px; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .lvl-btn.active { border-color: var(--primary); background: #f6ffed; color: var(--primary); box-shadow: 0 4px 12px rgba(82,196,26,0.2); }

        .unit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; padding: 20px; }
        .unit-card { 
            background: white; padding: 25px; border-radius: 18px; text-align: center; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; border: 2px solid transparent; 
        }
        .unit-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .unit-emoji { font-size: 45px; margin-bottom: 10px; display: block; }

        #gameView { display: none; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .game-area { display: flex; justify-content: space-around; min-height: 450px; margin-top: 20px; }
        .column { display: flex; flex-direction: column; gap: 12px; width: 45%; }
        .card { padding: 15px; background: #fff; border: 2px solid #e8e8e8; border-radius: 12px; cursor: pointer; text-align: center; min-height: 65px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; }
        .card.selected { background: #f6ffed; border-color: var(--primary); color: var(--primary); }
        .card.correct { background: #e6f7ff; border-color: var(--success); color: var(--success); cursor: default; }
        
        #reportOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:3000; justify-content:center; align-items:center; }
        .report-box { background:white; padding:40px; border-radius:25px; text-align:center; width: 85%; max-width: 400px; }
        
        /* é”™è¯ç»Ÿè®¡æ ·å¼ */
        #mistakesPanel {
            display: none;
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--error);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mistakes-title {
            font-weight: bold;
            color: var(--error);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mistakes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .mistake-item {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mistake-hanzi {
            font-weight: bold;
            font-size: 16px;
        }
        
        .mistake-pinyin {
            color: #666;
            font-size: 12px;
        }
        
        .mistake-translation {
            color: #888;
            font-size: 12px;
        }
        
        .clear-mistakes-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 12px;
        }
        
        .mistake-count {
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>

<div id="loginView">
    <div class="login-box">
        <h2 style="color:var(--primary)">ğŸ¼ Student Login</h2>
        <p style="color:#888; font-size:14px;">Please login for YCT 3-4</p>
        <input type="text" id="username" placeholder="Name / Ğ˜Ğ¼Ñ">
        <input type="password" id="password" placeholder="Password / ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ">
        <button class="lvl-btn active" style="width:100%" onclick="checkLogin()">Login / Ğ’Ñ…Ğ¾Ğ´</button>
        <p id="loginError" style="color:var(--error); display:none; margin-top:10px;">Error Login!</p>
    </div>
</div>

<div class="container">
    <div id="homeView">
        <h1 class="main-title">ğŸŒŸ YCT Vocabulary ğŸ¼</h1>
        <div id="levelSelector"></div>
        <div class="unit-grid" id="unitGrid"></div>
    </div>

    <div id="gameView">
        <div class="header">
            <button class="lvl-btn" onclick="goHome()">â† Back</button>
            <div style="text-align:center">
                <h2 id="unitTitle" style="margin:0;">Unit</h2>
                <div id="modeTag" style="color:var(--primary); font-size:13px; font-weight:bold;"></div>
            </div>
            <div id="timer" style="font-family:monospace; font-weight:bold;">00:00</div>
        </div>
        
        <!-- é”™è¯ç»Ÿè®¡é¢æ¿ -->
        <div id="mistakesPanel">
            <div class="mistakes-title">
                <span>é”™è¯ç»Ÿè®¡ <span id="mistakeCount" class="mistake-count">0</span></span>
                <button class="clear-mistakes-btn" onclick="clearMistakes()">æ¸…ç©º</button>
            </div>
            <div id="mistakesList" class="mistakes-list">
                <!-- é”™è¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <div class="game-area">
            <div class="column" id="leftCol"></div>
            <div class="column" id="rightCol"></div>
        </div>
        <div class="footer" style="display:flex; justify-content:space-between; margin-top:30px; align-items:center;">
            <div id="progress" style="font-weight:bold; color:#666;">Progress: 0/5</div>
            <button id="nextBtn" class="lvl-btn" style="background:#ccc; color:white; cursor:not-allowed;" onclick="nextLevel()">Next Level</button>
        </div>
    </div>
</div>

<div id="reportOverlay">
    <div class="report-box">
        <h2 style="color:var(--success)">Well Done! ğŸ‰</h2>
        <div id="reportContent" style="margin:20px 0; font-size:18px; line-height:1.8;"></div>
        <!-- é”™è¯å›é¡¾éƒ¨åˆ† -->
        <div id="mistakesReview" style="margin: 20px 0; text-align: left; display: none;">
            <h3 style="color: var(--error); margin-top: 0;">é”™è¯å›é¡¾</h3>
            <div id="reviewList" style="max-height: 200px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;"></div>
        </div>
        <button class="lvl-btn active" style="width:100%" onclick="goHome()">Back to Home</button>
    </div>
</div>

<script>
// --- 1. ç”¨æˆ·ä¸è¯åº“æ•°æ® ---
const users = { "Fedor": "yct3", "Mia": "yct3", "Dima": "yct3" };

// YCTç¤ºä¾‹æ•°æ® - ç­‰å¾…åç»­æ›¿æ¢
const allData = {
    yct1: {
        1: [
            { w: "ä½ å¥½", p: "nÇ hÇo", pos: "åŠ¨", en: "hello", ru: "Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚" },
            { w: "æˆ‘", p: "wÇ’", pos: "ä»£", en: "I, me", ru: "Ñ" },
            { w: "å¥½", p: "hÇo", pos: "å½¢", en: "good", ru: "Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹" },
            { w: "è°¢è°¢", p: "xiÃ¨ xie", pos: "åŠ¨", en: "thank you", ru: "ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾" },
            { w: "å†è§", p: "zÃ i jiÃ n", pos: "åŠ¨", en: "goodbye", ru: "Ğ´Ğ¾ ÑĞ²Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ" }
        ],
        2: [
            { w: "çˆ¸çˆ¸", p: "bÃ  ba", pos: "å", en: "father", ru: "Ğ¿Ğ°Ğ¿Ğ°" },
            { w: "å¦ˆå¦ˆ", p: "mÄ ma", pos: "å", en: "mother", ru: "Ğ¼Ğ°Ğ¼Ğ°" },
            { w: "æ˜¯", p: "shÃ¬", pos: "åŠ¨", en: "to be", ru: "Ğ±Ñ‹Ñ‚ÑŒ" },
            { w: "è€å¸ˆ", p: "lÇo shÄ«", pos: "å", en: "teacher", ru: "ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒ" },
            { w: "å­¦ç”Ÿ", p: "xuÃ© sheng", pos: "å", en: "student", ru: "ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚" }
        ],
        3: [
            { w: "ä¸€", p: "yÄ«", pos: "æ•°", en: "one", ru: "Ğ¾Ğ´Ğ¸Ğ½" },
            { w: "äºŒ", p: "Ã¨r", pos: "æ•°", en: "two", ru: "Ğ´Ğ²Ğ°" },
            { w: "ä¸‰", p: "sÄn", pos: "æ•°", en: "three", ru: "Ñ‚Ñ€Ğ¸" },
            { w: "å››", p: "sÃ¬", pos: "æ•°", en: "four", ru: "Ñ‡ĞµÑ‚Ñ‹Ñ€Ğµ" },
            { w: "äº”", p: "wÇ”", pos: "æ•°", en: "five", ru: "Ğ¿ÑÑ‚ÑŒ" }
        ],
        4: [
            { w: "å¤§", p: "dÃ ", pos: "å½¢", en: "big", ru: "Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹" },
            { w: "å°", p: "xiÇo", pos: "å½¢", en: "small", ru: "Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹" },
            { w: "å¤š", p: "duÅ", pos: "å½¢", en: "many", ru: "Ğ¼Ğ½Ğ¾Ğ³Ğ¾" },
            { w: "å°‘", p: "shÇo", pos: "å½¢", en: "few", ru: "Ğ¼Ğ°Ğ»Ğ¾" },
            { w: "å¥½", p: "hÇo", pos: "å½¢", en: "good", ru: "Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹" }
        ]
    },
    yct2: {
        1: [
            { w: "å®¶", p: "jiÄ", pos: "å", en: "home, family", ru: "Ğ´Ğ¾Ğ¼, ÑĞµĞ¼ÑŒÑ" },
            { w: "å­¦æ ¡", p: "xuÃ© xiÃ o", pos: "å", en: "school", ru: "ÑˆĞºĞ¾Ğ»Ğ°" },
            { w: "æœ‹å‹", p: "pÃ©ng you", pos: "å", en: "friend", ru: "Ğ´Ñ€ÑƒĞ³" },
            { w: "çŒ«", p: "mÄo", pos: "å", en: "cat", ru: "ĞºĞ¾ÑˆĞºĞ°" },
            { w: "ç‹—", p: "gÇ’u", pos: "å", en: "dog", ru: "ÑĞ¾Ğ±Ğ°ĞºĞ°" }
        ],
        2: [
            { w: "åƒ", p: "chÄ«", pos: "åŠ¨", en: "eat", ru: "ĞµÑÑ‚ÑŒ" },
            { w: "å–", p: "hÄ“", pos: "åŠ¨", en: "drink", ru: "Ğ¿Ğ¸Ñ‚ÑŒ" },
            { w: "çœ‹", p: "kÃ n", pos: "åŠ¨", en: "look, watch", ru: "ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ" },
            { w: "å¬", p: "tÄ«ng", pos: "åŠ¨", en: "listen", ru: "ÑĞ»ÑƒÑˆĞ°Ñ‚ÑŒ" },
            { w: "è¯´", p: "shuÅ", pos: "åŠ¨", en: "speak", ru: "Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ" }
        ],
        3: [
            { w: "ä»Šå¤©", p: "jÄ«n tiÄn", pos: "å", en: "today", ru: "ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ" },
            { w: "æ˜å¤©", p: "mÃ­ng tiÄn", pos: "å", en: "tomorrow", ru: "Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°" },
            { w: "æ˜¨å¤©", p: "zuÃ³ tiÄn", pos: "å", en: "yesterday", ru: "Ğ²Ñ‡ĞµÑ€Ğ°" },
            { w: "å¹´", p: "niÃ¡n", pos: "å", en: "year", ru: "Ğ³Ğ¾Ğ´" },
            { w: "æœˆ", p: "yuÃ¨", pos: "å", en: "month, moon", ru: "Ğ¼ĞµÑÑÑ†, Ğ»ÑƒĞ½Ğ°" }
        ],
        4: [
            { w: "çº¢è‰²", p: "hÃ³ng sÃ¨", pos: "å", en: "red", ru: "ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹" },
            { w: "è“è‰²", p: "lÃ¡n sÃ¨", pos: "å", en: "blue", ru: "ÑĞ¸Ğ½Ğ¸Ğ¹" },
            { w: "é»„è‰²", p: "huÃ¡ng sÃ¨", pos: "å", en: "yellow", ru: "Ğ¶Ñ‘Ğ»Ñ‚Ñ‹Ğ¹" },
            { w: "ç»¿è‰²", p: "lÇœ sÃ¨", pos: "å", en: "green", ru: "Ğ·ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹" },
            { w: "ç™½è‰²", p: "bÃ¡i sÃ¨", pos: "å", en: "white", ru: "Ğ±ĞµĞ»Ñ‹Ğ¹" }
        ]
    },
    yct3: {
        1: [
            { w: "æ—¶é—´", p: "shÃ­ jiÄn", pos: "å", en: "time", ru: "Ğ²Ñ€ĞµĞ¼Ñ" },
            { w: "å¤©æ°”", p: "tiÄn qÃ¬", pos: "å", en: "weather", ru: "Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ°" },
            { w: "å­¦ä¹ ", p: "xuÃ© xÃ­", pos: "åŠ¨", en: "study", ru: "ÑƒÑ‡Ğ¸Ñ‚ÑŒÑÑ" },
            { w: "å·¥ä½œ", p: "gÅng zuÃ²", pos: "åŠ¨", en: "work", ru: "Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ" },
            { w: "è¿åŠ¨", p: "yÃ¹n dÃ²ng", pos: "åŠ¨", en: "exercise", ru: "Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒÑÑ ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ¼" }
        ],
        2: [
            { w: "é«˜å…´", p: "gÄo xÃ¬ng", pos: "å½¢", en: "happy", ru: "Ñ€Ğ°Ğ´Ğ¾ÑÑ‚Ğ½Ñ‹Ğ¹" },
            { w: "å–œæ¬¢", p: "xÇ huan", pos: "åŠ¨", en: "like", ru: "Ğ½Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒÑÑ" },
            { w: "çˆ±", p: "Ã i", pos: "åŠ¨", en: "love", ru: "Ğ»ÑĞ±Ğ¸Ñ‚ÑŒ" },
            { w: "æƒ³", p: "xiÇng", pos: "åŠ¨", en: "think, want", ru: "Ğ´ÑƒĞ¼Ğ°Ñ‚ÑŒ, Ñ…Ğ¾Ñ‚ĞµÑ‚ÑŒ" },
            { w: "å¯ä»¥", p: "kÄ› yÇ", pos: "åŠ©", en: "can, may", ru: "Ğ¼Ğ¾Ğ¶Ğ½Ğ¾" }
        ],
        3: [
            { w: "æ—©ä¸Š", p: "zÇo shang", pos: "å", en: "morning", ru: "ÑƒÑ‚Ñ€Ğ¾" },
            { w: "ä¸­åˆ", p: "zhÅng wÇ”", pos: "å", en: "noon", ru: "Ğ¿Ğ¾Ğ»Ğ´ĞµĞ½ÑŒ" },
            { w: "æ™šä¸Š", p: "wÇn shang", pos: "å", en: "evening", ru: "Ğ²ĞµÑ‡ĞµÑ€" },
            { w: "æ˜ŸæœŸ", p: "xÄ«ng qÄ«", pos: "å", en: "week", ru: "Ğ½ĞµĞ´ĞµĞ»Ñ" },
            { w: "å°æ—¶", p: "xiÇo shÃ­", pos: "å", en: "hour", ru: "Ñ‡Ğ°Ñ" }
        ],
        4: [
            { w: "æ°´æœ", p: "shuÇ guÇ’", pos: "å", en: "fruit", ru: "Ñ„Ñ€ÑƒĞºÑ‚Ñ‹" },
            { w: "è”¬èœ", p: "shÅ« cÃ i", pos: "å", en: "vegetable", ru: "Ğ¾Ğ²Ğ¾Ñ‰Ğ¸" },
            { w: "ç±³é¥­", p: "mÇ fÃ n", pos: "å", en: "rice", ru: "Ñ€Ğ¸Ñ" },
            { w: "é¢åŒ…", p: "miÃ n bÄo", pos: "å", en: "bread", ru: "Ñ…Ğ»ĞµĞ±" },
            { w: "ç‰›å¥¶", p: "niÃº nÇi", pos: "å", en: "milk", ru: "Ğ¼Ğ¾Ğ»Ğ¾ĞºĞ¾" }
        ]
    },
    yct4: {
        1: [
            { w: "æ—…è¡Œ", p: "lÇš xÃ­ng", pos: "åŠ¨", en: "travel", ru: "Ğ¿ÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ" },
            { w: "æ–‡åŒ–", p: "wÃ©n huÃ ", pos: "å", en: "culture", ru: "ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°" },
            { w: "å†å²", p: "lÃ¬ shÇ", pos: "å", en: "history", ru: "Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ" },
            { w: "ç§‘å­¦", p: "kÄ“ xuÃ©", pos: "å", en: "science", ru: "Ğ½Ğ°ÑƒĞºĞ°" },
            { w: "è‰ºæœ¯", p: "yÃ¬ shÃ¹", pos: "å", en: "art", ru: "Ğ¸ÑĞºÑƒÑÑÑ‚Ğ²Ğ¾" }
        ],
        2: [
            { w: "å¥åº·", p: "jiÃ n kÄng", pos: "å", en: "health", ru: "Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ" },
            { w: "ç¯å¢ƒ", p: "huÃ¡n jÃ¬ng", pos: "å", en: "environment", ru: "Ğ¾ĞºÑ€ÑƒĞ¶Ğ°ÑÑ‰Ğ°Ñ ÑÑ€ĞµĞ´Ğ°" },
            { w: "ç¤¾ä¼š", p: "shÃ¨ huÃ¬", pos: "å", en: "society", ru: "Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ¾" },
            { w: "ç»æµ", p: "jÄ«ng jÃ¬", pos: "å", en: "economy", ru: "ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ°" },
            { w: "å‘å±•", p: "fÄ zhÇn", pos: "åŠ¨", en: "develop", ru: "Ñ€Ğ°Ğ·Ğ²Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ" }
        ],
        3: [
            { w: "è™½ç„¶", p: "suÄ« rÃ¡n", pos: "è¿", en: "although", ru: "Ñ…Ğ¾Ñ‚Ñ" },
            { w: "ä½†æ˜¯", p: "dÃ n shÃ¬", pos: "è¿", en: "but", ru: "Ğ½Ğ¾" },
            { w: "å› ä¸º", p: "yÄ«n wÃ¨i", pos: "è¿", en: "because", ru: "Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾" },
            { w: "æ‰€ä»¥", p: "suÇ’ yÇ", pos: "è¿", en: "so", ru: "Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ" },
            { w: "å¦‚æœ", p: "rÃº guÇ’", pos: "è¿", en: "if", ru: "ĞµÑĞ»Ğ¸" }
        ],
        4: [
            { w: "å»ºè®®", p: "jiÃ n yÃ¬", pos: "å", en: "suggestion", ru: "Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ" },
            { w: "å†³å®š", p: "juÃ© dÃ¬ng", pos: "åŠ¨", en: "decide", ru: "Ñ€ĞµÑˆĞ°Ñ‚ÑŒ" },
            { w: "è®¡åˆ’", p: "jÃ¬ huÃ ", pos: "å", en: "plan", ru: "Ğ¿Ğ»Ğ°Ğ½" },
            { w: "ç›®æ ‡", p: "mÃ¹ biÄo", pos: "å", en: "goal", ru: "Ñ†ĞµĞ»ÑŒ" },
            { w: "æˆåŠŸ", p: "chÃ©ng gÅng", pos: "åŠ¨", en: "succeed", ru: "ÑƒÑĞ¿ĞµÑ…" }
        ]
    }
};

// --- 2. æ ¸å¿ƒçŠ¶æ€ç®¡ç† ---
let G = { 
    lvl: 1, 
    unit: 1, 
    step: 1, 
    matched: 0, 
    errors: 0, 
    start: 0, 
    selL: null, 
    selR: null, 
    wrongList: [], // é”™è¯åˆ—è¡¨
    mistakeItems: [] // è¯¦ç»†é”™è¯è®°å½•
};

// --- 3. é¦–é¡µæ¸²æŸ“é€»è¾‘ ---
function renderLevelSelector() {
    const box = document.getElementById('levelSelector');
    let html = '';
    for(let i=1; i<=4; i++) { // YCTåªæœ‰4ä¸ªçº§åˆ«
        const locked = (i >= 3 && !G.user);
        html += `<button class="lvl-btn ${G.lvl === i ? 'active' : ''}" onclick="selectLevel(${i})">
            YCT ${i} ${locked ? 'ğŸ”’' : ''}
        </button>`;
    }
    box.innerHTML = html;
}

function selectLevel(n) {
    if(n >= 3 && !G.user) {
        document.getElementById('loginView').style.display = 'flex';
        return;
    }
    G.lvl = n;
    renderLevelSelector();
    renderGrid();
}

function renderGrid() {
    const grid = document.getElementById('unitGrid');
    const icons = ["ğŸ¼", "ğŸ¨", "ğŸ“š", "âœ¨", "ğŸ", "ğŸ¨", "ğŸš€", "ğŸŒˆ", "ğŸ±", "ğŸ¦Š", "ğŸ¦", "ğŸ’"];
    const levelData = allData[`yct${G.lvl}`] || {};
    const units = Object.keys(levelData);

    if(units.length === 0) {
        grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#999;">Units coming soon...</p>';
        return;
    }

    grid.innerHTML = units.map((u, i) => `
        <div class="unit-card" onclick="startUnit(${u})">
            <span class="unit-emoji">${icons[i % icons.length]}</span>
            <span>Unit ${u}</span>
        </div>
    `).join('');
}

// --- 4. ç™»å½•é€»è¾‘ ---
function checkLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if(users[u] && users[u] === p) {
        G.user = u;
        document.getElementById('loginView').style.display = 'none';
        renderLevelSelector();
        renderGrid();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

// --- 5. æ¸¸æˆå¼•æ“é€»è¾‘ ---
function startUnit(id) {
    G.unit = id; 
    G.step = 1; 
    G.errors = 0; 
    G.start = Date.now();
    G.wrongList = []; // é‡ç½®é”™è¯åˆ—è¡¨
    G.mistakeItems = []; // é‡ç½®è¯¦ç»†é”™è¯è®°å½•
    
    document.getElementById('homeView').style.display = 'none';
    document.getElementById('gameView').style.display = 'block';
    document.getElementById('unitTitle').innerText = `YCT ${G.lvl} - Unit ${id}`;
    
    // éšè—é”™è¯é¢æ¿
    document.getElementById('mistakesPanel').style.display = 'none';
    
    initStep();
}

function initStep() {
    G.matched = 0; 
    G.selL = null; 
    G.selR = null;
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.style.background = '#ccc';
    nextBtn.style.cursor = 'not-allowed';
    
    const isPinyin = G.step <= 5;
    document.getElementById('modeTag').innerText = isPinyin ? "Hanzi â†” Pinyin" : "Hanzi â†” Translation";
    
    const pool = allData[`yct${G.lvl}`][G.unit];
    
    // --- æ ¸å¿ƒä¼˜åŒ–ï¼šé˜²åŒéŸ³å­—é€»è¾‘å¼€å§‹ ---
    let words = [];
    let usedPinyin = new Set(); // è®°å½•å·²ç»é€‰è¿›å»çš„æ‹¼éŸ³
    
    // å…ˆæŠŠæ± å­é‡Œçš„è¯éšæœºæ‰“ä¹±
    let shuffledPool = [...pool].sort(() => Math.random() - 0.5);
    
    for (let item of shuffledPool) {
        // å¦‚æœæ˜¯æ‹¼éŸ³æ¨¡å¼ï¼Œæ£€æŸ¥æ‹¼éŸ³æ˜¯å¦å·²ç»å­˜åœ¨äºè¿™ä¸€ç»„ä¸­
        if (isPinyin) {
            if (!usedPinyin.has(item.p)) {
                words.push(item);
                usedPinyin.add(item.p);
            }
        } else {
            // å¦‚æœæ˜¯ç¿»è¯‘æ¨¡å¼ï¼Œé€šå¸¸ä¸éœ€è¦é˜²é‡éŸ³ï¼Œç›´æ¥åŠ è¿›å»
            words.push(item);
        }
        
        // å‡‘å¤Ÿ5ä¸ªå°±åœæ­¢
        if (words.length === 5) break;
    }
    
    // ä¿åº•æœºåˆ¶ï¼šå¦‚æœè¯åº“å¤ªå°ï¼ŒæŒ‘äº†åŠå¤©å‡‘ä¸å¤Ÿ5ä¸ªä¸é‡éŸ³çš„è¯ï¼Œå°±è¿˜æ˜¯æŒ‰åŸæ ·è¡¥é½
    if (words.length < 5) {
        words = shuffledPool.slice(0, 5);
    }
    // --- é˜²åŒéŸ³å­—é€»è¾‘ç»“æŸ ---
    
    const lCol = document.getElementById('leftCol');
    const rCol = document.getElementById('rightCol');
    lCol.innerHTML = ''; rCol.innerHTML = '';
    
    // æ¸²æŸ“å·¦ä¾§ï¼ˆæ±‰å­—ï¼‰
    words.forEach(item => {
        const d = document.createElement('div'); 
        d.className = 'card'; 
        d.innerText = item.w;
        d.onclick = () => handleSelect('L', item, d); 
        lCol.appendChild(d);
    });
    
    // æ¸²æŸ“å³ä¾§ï¼ˆæ‹¼éŸ³æˆ–ç¿»è¯‘ï¼‰
    [...words].sort(() => Math.random() - 0.5).forEach(item => {
        const d = document.createElement('div'); 
        d.className = 'card';
        d.innerText = isPinyin ? item.p : `${item.en} / ${item.ru}`;
        d.onclick = () => handleSelect('R', item, d); 
        rCol.appendChild(d);
    });
    
    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
    document.getElementById('progress').innerText = `Progress: ${G.matched}/5`;
}

function handleSelect(side, data, el) {
    if(el.classList.contains('correct')) return;
    
    if(side === 'L') {
        document.querySelectorAll('#leftCol .card').forEach(c => c.classList.remove('selected'));
        G.selL = { data, el };
    } else {
        document.querySelectorAll('#rightCol .card').forEach(c => c.classList.remove('selected'));
        G.selR = { data, el };
    }
    el.classList.add('selected');

    if(G.selL && G.selR) {
        if(G.selL.data.w === G.selR.data.w) {
            // åŒ¹é…æ­£ç¡®
            G.selL.el.className = 'card correct';
            G.selR.el.className = 'card correct';
            G.matched++;
            document.getElementById('progress').innerText = `Progress: ${G.matched}/5`;
            if(G.matched === 5) {
                document.getElementById('nextBtn').style.background = 'var(--success)';
                document.getElementById('nextBtn').style.cursor = 'pointer';
            }
        } else {
            // åŒ¹é…é”™è¯¯ - è®°å½•é”™è¯
            G.errors++;
            
            // è®°å½•é”™è¯ï¼ˆé¿å…é‡å¤ï¼‰
            if (!G.wrongList.includes(G.selL.data.w)) {
                G.wrongList.push(G.selL.data.w);
            }
            
            // è®°å½•è¯¦ç»†é”™è¯ä¿¡æ¯
            const mistakeItem = {
                hanzi: G.selL.data.w,
                pinyin: G.selL.data.p,
                english: G.selL.data.en,
                russian: G.selL.data.ru,
                timestamp: new Date().toLocaleTimeString(),
                mode: G.step <= 5 ? 'æ‹¼éŸ³' : 'ç¿»è¯‘'
            };
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé”™è¯
            const exists = G.mistakeItems.some(item => item.hanzi === mistakeItem.hanzi);
            if (!exists) {
                G.mistakeItems.push(mistakeItem);
                updateMistakesPanel();
            }
            
            // é”™è¯¯åŠ¨ç”»æ•ˆæœ
            const l = G.selL.el; 
            const r = G.selR.el;
            l.style.borderColor = 'var(--error)';
            r.style.borderColor = 'var(--error)';
            
            setTimeout(() => { 
                l.classList.remove('selected'); 
                r.classList.remove('selected');
                l.style.borderColor = '';
                r.style.borderColor = '';
            }, 400);
        }
        G.selL = null; 
        G.selR = null;
    }
}

// æ›´æ–°é”™è¯é¢æ¿
function updateMistakesPanel() {
    const mistakesPanel = document.getElementById('mistakesPanel');
    const mistakesList = document.getElementById('mistakesList');
    const mistakeCount = document.getElementById('mistakeCount');
    
    if (G.mistakeItems.length > 0) {
        mistakesPanel.style.display = 'block';
        mistakeCount.textContent = G.mistakeItems.length;
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        mistakesList.innerHTML = '';
        
        // æ·»åŠ é”™è¯é¡¹
        G.mistakeItems.forEach((item, index) => {
            const mistakeDiv = document.createElement('div');
            mistakeDiv.className = 'mistake-item';
            mistakeDiv.innerHTML = `
                <span class="mistake-hanzi">${item.hanzi}</span>
                <span class="mistake-pinyin">${item.pinyin}</span>
                <span class="mistake-translation">${item.english}</span>
            `;
            mistakesList.appendChild(mistakeDiv);
        });
    } else {
        mistakesPanel.style.display = 'none';
    }
}

// æ¸…ç©ºé”™è¯
function clearMistakes() {
    G.mistakeItems = [];
    G.wrongList = [];
    updateMistakesPanel();
}

function nextLevel() {
    if(G.matched < 5) return;
    if(G.step < 10) { 
        G.step++; 
        initStep(); 
    } else { 
        showReport(); 
    }
}

function showReport() {
    const time = Math.floor((Date.now() - G.start)/1000);
    document.getElementById('reportOverlay').style.display = 'flex';
    
    let reportHtml = `
        <h2 style="margin-top:0">Unit Complete!</h2>
        <div style="text-align:left; background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
            <strong>Level:</strong> YCT ${G.lvl}<br>
            <strong>Unit:</strong> ${G.unit}<br>
            <strong>Time:</strong> ${time} seconds<br>
            <strong>Total Errors:</strong> <span style="color:var(--error)">${G.errors}</span> times
        </div>
    `;

    // é”™è¯å›é¡¾éƒ¨åˆ†
    const mistakesReview = document.getElementById('mistakesReview');
    const reviewList = document.getElementById('reviewList');
    
    if (G.mistakeItems.length > 0) {
        reportHtml += `<p style="color:var(--error); font-weight:bold;">You made ${G.mistakeItems.length} mistakes!</p>`;
        
        // æ˜¾ç¤ºé”™è¯å›é¡¾
        mistakesReview.style.display = 'block';
        
        let reviewHtml = '';
        G.mistakeItems.forEach((item, index) => {
            reviewHtml += `
                <div style="padding: 8px; border-bottom: 1px solid #eee; ${index === G.mistakeItems.length - 1 ? 'border-bottom: none;' : ''}">
                    <div style="font-weight: bold; font-size: 16px;">${item.hanzi}</div>
                    <div style="font-size: 12px; color: #666;">${item.pinyin}</div>
                    <div style="font-size: 12px; color: #888;">
                        <span>${item.english}</span> | 
                        <span>${item.russian}</span>
                    </div>
                    <div style="font-size: 10px; color: #aaa; margin-top: 4px;">
                        Mode: ${item.mode} | Time: ${item.timestamp}
                    </div>
                </div>
            `;
        });
        reviewList.innerHTML = reviewHtml;
    } else {
        reportHtml += `<p style="color:var(--success); font-weight:bold;">Perfect! No mistakes!</p>`;
        mistakesReview.style.display = 'none';
    }

    document.getElementById('reportContent').innerHTML = reportHtml;
}

function goHome() {
    document.getElementById('gameView').style.display = 'none';
    document.getElementById('reportOverlay').style.display = 'none';
    document.getElementById('homeView').style.display = 'block';
    renderGrid();
}

// --- 6. è‡ªåŠ¨è®¡æ—¶å™¨ ---
setInterval(() => {
    if(document.getElementById('gameView').style.display === 'block') {
        const d = Math.floor((Date.now()-G.start)/1000);
        document.getElementById('timer').innerText = `${String(Math.floor(d/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
    }
}, 1000);

// --- 7. å¯åŠ¨ ---
renderLevelSelector();
renderGrid();
</script>
</body>
</html>
<p><a href="index.html">è¿”å›é¦–é¡µ</a></p>